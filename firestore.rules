rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // SUPER ADMIN GLOBAL OVERRIDE - Must be first rule
    match /{document=**} {
      allow read, write: if request.auth != null && request.auth.token.super_admin == true;
    }

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return request.auth != null && request.auth.token.super_admin == true;
    }

    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    function isCommunityCreator(communityId) {
      return exists(/databases/$(database)/documents/communities/$(communityId)) &&
             get(/databases/$(database)/documents/communities/$(communityId)).data.createdBy == request.auth.uid;
    }
    
    function isCommunityAdmin(communityId) {
      // Check if user is the community creator (automatic admin rights)
      let isCreator = isCommunityCreator(communityId);

      // Check if user has admin role in roles subcollection
      let hasAdminRole = exists(/databases/$(database)/documents/communities/$(communityId)/roles/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/communities/$(communityId)/roles/$(request.auth.uid)).data.role == 'community_admin';

      return isCreator || hasAdminRole;
    }

    function isCommunityModerator(communityId) {
      // Check if user is the community creator (automatic admin rights)
      let isCreator = isCommunityCreator(communityId);

      // Check if user has moderator or admin role
      let hasModeratorRole = exists(/databases/$(database)/documents/communities/$(communityId)/roles/$(request.auth.uid)) &&
                             get(/databases/$(database)/documents/communities/$(communityId)/roles/$(request.auth.uid)).data.role in ['community_admin', 'community_moderator'];

      return isCreator || hasModeratorRole;
    }

    function isCommunityMember(communityId) {
      // Check if user is the community creator (automatic member rights)
      let isCreator = isCommunityCreator(communityId);

      // Check if user has any role in the community
      let hasRole = exists(/databases/$(database)/documents/communities/$(communityId)/roles/$(request.auth.uid));

      // Check if user has membership document in communityMembers collection
      // Note: Since membership documents use auto-generated IDs, we need to check if any document
      // exists where uid == current user AND communityId == target community
      // For security rules, we'll use a simplified approach and rely on the read permissions
      // of the communityMembers collection to validate membership

      return isCreator || hasRole;
    }


    
    // User profiles
    match /users/{uid} {
      allow read: if isAuthenticated() && (isOwner(uid) || isSuperAdmin());
      allow write: if isAuthenticated() && isOwner(uid);
      allow create: if isAuthenticated() && isOwner(uid);
      allow delete: if isAuthenticated() && (isOwner(uid) || isSuperAdmin());
    }
    
    // Communities - CRITICAL FIX: Allow reading for discovery and user communities
    match /communities/{communityId} {
      // Community metadata - readable by authenticated users for discovery
      allow read: if isAuthenticated(); // Allow all authenticated users to read communities for discovery
      allow create: if isAuthenticated(); // Any user can create communities

      // Allow updates for community creators, super admins, and specific join operations
      allow update: if isAuthenticated() && (
        // Community creator can update their community (full access)
        resource.data.createdBy == request.auth.uid ||
        // Super admin can update any community (full access)
        isSuperAdmin() ||
        // Allow specific join-related field updates for any authenticated user
        (request.resource.data.keys().hasOnly(['memberCount', 'lastActivity'])) ||
        // Allow join request storage updates for any authenticated user
        (request.resource.data.keys().hasOnly(['pendingJoinRequests', 'pendingRequestsCount'])) ||
        // Allow combined join operation updates (direct join with member count)
        (request.resource.data.keys().hasOnly(['memberCount', 'lastActivity', 'pendingJoinRequests', 'pendingRequestsCount']))
      );

      // Special delete rule to avoid circular dependency in isCommunityAdmin function
      allow delete: if isAuthenticated() && (
        // Allow if user is the community creator (direct check without function)
        resource.data.createdBy == request.auth.uid ||
        // Allow if user has admin role in roles subcollection
        (exists(/databases/$(database)/documents/communities/$(communityId)/roles/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/communities/$(communityId)/roles/$(request.auth.uid)).data.role == 'community_admin') ||
        // Allow super admins
        isSuperAdmin()
      );
      
      // Community roles subcollection
      match /roles/{uid} {
        // Allow authenticated users to read roles (needed for membership validation)
        allow read: if isAuthenticated();

        // Allow community creators to manage roles
        allow write: if isAuthenticated() && (
          // Community creator can manage roles
          (exists(/databases/$(database)/documents/communities/$(communityId)) &&
           get(/databases/$(database)/documents/communities/$(communityId)).data.createdBy == request.auth.uid) ||
          // Super admin can manage roles
          isSuperAdmin()
        );

        // Allow community creators to create roles
        allow create: if isAuthenticated() && (
          // Community creator can create roles
          (exists(/databases/$(database)/documents/communities/$(communityId)) &&
           get(/databases/$(database)/documents/communities/$(communityId)).data.createdBy == request.auth.uid) ||
          // Super admin can create roles
          isSuperAdmin()
        );

        // Allow community creators to delete roles
        allow delete: if isAuthenticated() && (
          // Community creator can delete roles
          (exists(/databases/$(database)/documents/communities/$(communityId)) &&
           get(/databases/$(database)/documents/communities/$(communityId)).data.createdBy == request.auth.uid) ||
          // Super admin can delete roles
          isSuperAdmin()
        );
      }

      // Community messages (new structure - direct under community)
      match /messages/{messageId} {
        // Allow all authenticated users to read messages
        allow read: if isAuthenticated();

        // Allow authenticated users to create messages with their own authorId
        allow create: if isAuthenticated() &&
                      request.resource.data.authorId == request.auth.uid &&
                      request.resource.data.communityId == communityId;

        // Simplified update rules to avoid function call issues
        allow update: if isAuthenticated() && (
          // Original author can edit their message content
          (resource.data.authorId == request.auth.uid &&
           request.resource.data.authorId == resource.data.authorId &&
           request.resource.data.communityId == resource.data.communityId) ||
          // Any authenticated user can update specific fields
          (request.resource.data.keys().hasAny(['hasThread', 'threadCount', 'threadName', 'reactions', 'questionAnswers'])) ||
          // Any authenticated user can pin/unpin (simplified for debugging)
          (request.resource.data.keys().hasAny(['isPinned', 'pinnedBy', 'pinnedAt']))
        );

        // Simplified delete rule
        allow delete: if isAuthenticated() && (
          resource.data.authorId == request.auth.uid ||
          isSuperAdmin()
        );

        // Thread messages subcollection
        match /threads/{threadMessageId} {
          // Allow authenticated users to read thread messages
          allow read: if isAuthenticated();

          // Allow authenticated users to create thread messages with their own authorId
          allow create: if isAuthenticated() &&
                        request.resource.data.authorId == request.auth.uid &&
                        request.resource.data.communityId == communityId;

          // Allow original author to update their thread messages
          allow update: if isAuthenticated() && resource.data.authorId == request.auth.uid;

          // Allow original author or super admin to delete thread messages
          allow delete: if isAuthenticated() && (
            resource.data.authorId == request.auth.uid ||
            isSuperAdmin()
          );
        }
      }

      // Community resources (nested under community)
      match /resources/{resourceId} {
        // Allow all authenticated users to read resources (application logic handles membership)
        allow read: if isAuthenticated();

        // Allow authenticated users to create resources (application logic handles membership)
        allow create: if isAuthenticated();

        // Allow resource authors and community creators to update resources
        allow update: if isAuthenticated() && (
          // Resource author can update their resource
          resource.data.authorId == request.auth.uid ||
          // Community creator can update resources
          (exists(/databases/$(database)/documents/communities/$(communityId)) &&
           get(/databases/$(database)/documents/communities/$(communityId)).data.createdBy == request.auth.uid) ||
          // Super admin can update resources
          isSuperAdmin()
        );

        // Allow resource authors and community creators to delete resources
        allow delete: if isAuthenticated() && (
          // Resource author can delete their resource
          resource.data.authorId == request.auth.uid ||
          // Community creator can delete resources
          (exists(/databases/$(database)/documents/communities/$(communityId)) &&
           get(/databases/$(database)/documents/communities/$(communityId)).data.createdBy == request.auth.uid) ||
          // Super admin can delete resources
          isSuperAdmin()
        );
      }

      // Community events
      match /events/{eventId} {
        // Allow all authenticated users to read events (application logic handles membership)
        allow read: if isAuthenticated();

        // Allow authenticated users to create events (application logic handles membership)
        allow create: if isAuthenticated();

        // Allow event creators and community creators to update events
        allow update: if isAuthenticated() && (
          // Event creator can update their event
          resource.data.createdBy == request.auth.uid ||
          // Community creator can update events
          (exists(/databases/$(database)/documents/communities/$(communityId)) &&
           get(/databases/$(database)/documents/communities/$(communityId)).data.createdBy == request.auth.uid) ||
          // Super admin can update events
          isSuperAdmin()
        );

        // Allow event creators and community creators to delete events
        allow delete: if isAuthenticated() && (
          // Event creator can delete their event
          resource.data.createdBy == request.auth.uid ||
          // Community creator can delete events
          (exists(/databases/$(database)/documents/communities/$(communityId)) &&
           get(/databases/$(database)/documents/communities/$(communityId)).data.createdBy == request.auth.uid) ||
          // Super admin can delete events
          isSuperAdmin()
        );
      }

      // Community announcements
      match /announcements/{announcementId} {
        // Allow all authenticated users to read announcements
        // Application logic will handle community membership validation
        allow read: if isAuthenticated();

        // Allow community creators to create announcements
        allow create: if isAuthenticated() && (
          // Community creator can create announcements
          (exists(/databases/$(database)/documents/communities/$(communityId)) &&
           get(/databases/$(database)/documents/communities/$(communityId)).data.createdBy == request.auth.uid) ||
          // Super admin can create announcements
          isSuperAdmin()
        );

        // Allow community creators to update announcements
        allow update: if isAuthenticated() && (
          // Community creator can update announcements
          (exists(/databases/$(database)/documents/communities/$(communityId)) &&
           get(/databases/$(database)/documents/communities/$(communityId)).data.createdBy == request.auth.uid) ||
          // Super admin can update announcements
          isSuperAdmin()
        );

        // Allow community creators to delete announcements
        allow delete: if isAuthenticated() && (
          // Community creator can delete announcements
          (exists(/databases/$(database)/documents/communities/$(communityId)) &&
           get(/databases/$(database)/documents/communities/$(communityId)).data.createdBy == request.auth.uid) ||
          // Super admin can delete announcements
          isSuperAdmin()
        );
      }

      // Community announcement reads (user read tracking)
      match /announcementReads/{userId} {
        // Users can only read/write their own read status
        // Simplified: Allow if user is authenticated and owns the document
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // Top-level resources collection (for current implementation)
    match /resources/{resourceId} {
      // SIMPLIFIED: Allow all authenticated users to read resources for now
      // TODO: Implement proper community membership checking
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() && request.resource.data.uploadedBy == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.uploadedBy == request.auth.uid ||
        isSuperAdmin()
      );
      allow delete: if isAuthenticated() && (
        resource.data.uploadedBy == request.auth.uid ||
        isSuperAdmin()
      );
    }

    // Join requests - for community approval workflow
    match /joinRequests/{requestId} {
      // Users can create join requests for themselves
      allow create: if isAuthenticated() &&
                    request.auth.uid == request.resource.data.userId &&
                    request.resource.data.communityId != null;

      // Users can read their own join requests, community creators can read requests for their communities
      allow read: if isAuthenticated() && (
        // User can read their own requests
        request.auth.uid == resource.data.userId ||
        // Community creator can read requests for their community
        (exists(/databases/$(database)/documents/communities/$(resource.data.communityId)) &&
         get(/databases/$(database)/documents/communities/$(resource.data.communityId)).data.createdBy == request.auth.uid) ||
        // Super admin can read all requests
        isSuperAdmin()
      );

      // Community creators can update join requests (approve/reject)
      allow update: if isAuthenticated() && (
        // Community creator can update requests for their community
        (exists(/databases/$(database)/documents/communities/$(resource.data.communityId)) &&
         get(/databases/$(database)/documents/communities/$(resource.data.communityId)).data.createdBy == request.auth.uid) ||
        // Super admin can update requests
        isSuperAdmin()
      );

      // Community creators can delete join requests
      allow delete: if isAuthenticated() && (
        // Community creator can delete requests for their community
        (exists(/databases/$(database)/documents/communities/$(resource.data.communityId)) &&
         get(/databases/$(database)/documents/communities/$(resource.data.communityId)).data.createdBy == request.auth.uid) ||
        // Super admin can delete requests
        isSuperAdmin()
      );

      // Allow querying for authenticated users (application logic will filter by community)
      allow list: if isAuthenticated();
    }

    // Community members collection - SIMPLIFIED: Allow authenticated users to read memberships
    match /communityMembers/{memberId} {
      // Allow all authenticated users to read community memberships (needed for UI)
      allow read: if isAuthenticated();

      // Users can create their own membership when joining (direct join)
      allow create: if isAuthenticated() &&
                    request.auth.uid == request.resource.data.uid &&
                    request.resource.data.communityId != null;

      // Allow updates for community creators and super admins only
      allow update: if isAuthenticated() && (
        // Community creator can update memberships
        (exists(/databases/$(database)/documents/communities/$(resource.data.communityId)) &&
         get(/databases/$(database)/documents/communities/$(resource.data.communityId)).data.createdBy == request.auth.uid) ||
        // Super admin can update memberships
        isSuperAdmin()
      );

      // Allow deletion for community creators and super admins only
      allow delete: if isAuthenticated() && (
        // Community creator can delete memberships
        (exists(/databases/$(database)/documents/communities/$(resource.data.communityId)) &&
         get(/databases/$(database)/documents/communities/$(resource.data.communityId)).data.createdBy == request.auth.uid) ||
        // Super admin can delete memberships
        isSuperAdmin()
      );
    }

    // Typing indicators (temporary documents)
    match /typing/{communityId}/indicators/{userId} {
      // Allow all authenticated users to read typing indicators
      allow read: if isAuthenticated();
      // Allow users to create their own typing indicators
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Allow users to update their own typing indicators
      allow update: if isAuthenticated() && request.auth.uid == userId;
      // Allow users to write (create/update) their own typing indicators
      allow write: if isAuthenticated() && request.auth.uid == userId;
      // Allow users to delete their own typing indicators
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }


  }
}
